# 교착 상태

### 교착 상태란?

2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만을 기다리며 작업을 더 이상 진행하지 못하는 상태

### 교착 상태의 발생

- 시스템 자원 : 프로세스가 임계구역으로 보호되는 시스템 자원을 할당 받은 후 양보하지 않는 경우 교착상태가 발생할 수 있다.

- 공유 변수 : 2개 이상의 프로세스가 임계구역에 동시에 접근할 때 잠금과 관련된 공유 변수 때문에 무한 대기에 걸리는 교착상태가 발생할 수 있다.

- 응용 프로그램 : DB는 데이터 일관성을 유지하기 위해 잠금을 사용하는데 이 때 교착 상태가 발생할 수 있다.

### 자원 할당 그래프

![](https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTWEMb8-q_xI1rYolFn00sI82wrtu9HME3Z7A&usqp=CAU)

- 프로세스가 자원을 할당 받으면, 프로세스 <ㅡ 자원
- 프로세스가 자원을 요청하면, 프로세스 ㅡ> 자원
- 프로세스가 자원의 잠금이 풀리길 기다리면, 프로세스 ---> 자원

(식사하는 철학자 예시)

![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F2523F64E572F2C1E09)

### 교착 상태의 필요조건

- 상호 배제 : 한 프로세스가 사용중인 자원의 임계구역에 다른 프로세스가 접근할 수 없어야 한다.

- 비선점 : 한 프로세스가 사용중인 자원은 중간에 다른 프로세스가 빼앗을 수 없어야 한다.

- 점유와 대기 : 프로세스가 어떤 자원을 할당받은 후에 다른 자원을 기다리는 상태여야 한다.

- 원형 대기 : 점유와 대기를 하는 프로세스들간의 관계가 원을 이루어야 한다.

### 식사하는 철학자와 교착상태의 필요조건

- 상호 배제 : 포크는 한번에 1명 만이 사용할 수 있다.
- 비선점 : 포크가 사용중이면 그 철학자가 포크를 다 사용하기 전까지 다른 철학자가 사용할 수 없다.

- 점유와 대기 : 철학자가 포크 하나를 들고 다른 하나를 들기 위해 대기중이다.

- 원형 대기 : 철학자와 포크가 원형 관계를 이루고 있다.

### 교착 상태 해결 방법

| 해결방법              | 특징                                                      | 한계                                                                  |
| --------------------- | --------------------------------------------------------- | --------------------------------------------------------------------- |
| 교착 상태 예방        | 교착 상태를 유발하는 4가지 조건 중 1개 이상을 무력화한다. | 실효성이 적다.                                                        |
| 교착 상태 회피        | 교착 상태가 발생하지 않는 수준으로 자원을 할당한다.       | 어느정도의 자원을 할당해야 교착 상태가 발생하지 않는지 판별이 어렵다. |
| 교착 상태 검출과 회복 | 자원 할당 그래프를 사용하여 교착상태를 발견하고 회복한다. | 현실적인 해결방법                                                     |

### 교착 상태 예방

#### 상호 배제 예방

독점적으로 사용할 수 있는 자원을 공유 가능하게 바꾼다.

한계 :

현실적으로 공유 불가능한 자원이 존재하며, 임계 구역을 설정하기 않으면 여러가지 문제가 발생할 수 있다.

#### 비선점 예방

모든 자원을 빼앗을 수 있게 바꾼다.

한계 :

임계구역을 설정하면 뺴앗을 수 없으며, 빼앗는 기준도 결정하기 어렵다. starvation 발생의 가능성도 있다.

#### 점유와 대기 예방

자원을 일정부분 점유한 상태로 대기하지 못하게 모든 자원을 한꺼번에 점유하거나 그렇지 못하게 되면 자원을 모두 반납하게 한다.

한계 :

프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어렵다.

자원을 효율적으로 활용할 수 없다.

자원을 많이 사용하는 프로세스는 실행되기 어렵다.

사실상 일괄 작업 방식으로 동작한다.

#### 원형 대기 예방

자원에 번호를 붙여 번호를 대소비교하고 일정 순서에 따라 사용할 수 있게 한다.

한계 :

프로세스 작업 진행에 유연성이 떨어진다.

자원에 번호를 어떻게 부여할지에 대한 결정이 어렵다.

### 교착 상태 회피

![](https://blog.kakaocdn.net/dn/MOG6E/btqAyyPEyeQ/eOOe0CXyEAyRojjhF1uyq1/img.png)

프로세스에 자원을 할당할 때 자원의 할당량에 따른 안정/불안정 상태를 파악한 후 자원 할당량을 조절하는 방식이다.

#### 은행원 알고리즘

| 변수                  | 설명                                    |
| --------------------- | --------------------------------------- |
| 전체 자원(Total)      | 시스템 내 전체 자원의 수                |
| 가용 자원(Available)  | 시스템 내 현재 사용할 수 있는 자원의 수 |
| 최대 자원(Max)        | 각 프로세스가 선언한 최대 자원의 수     |
| 할당 자원(Allocation) | 각 프로세스에 현재 할당된 자원의 수     |
| 기대 자원(Expect)     | 각 프로세스가 앞으로 사용할 자원의 수   |

- 각 프로세스가 기대 자원과 비교하여 가용 자원이 크거나 같으면 자원을 할당한다. 가용 자원이 기대 자원보다 크다는 것은 그 자원을 사용하여 작업을 끝낼 수 있는 프로세스가 있다는 의미이므로 **안정 상태**이다.

![](https://1.bp.blogspot.com/-ArTD0XeTSSc/WP4Cm-fH9pI/AAAAAAAABLw/tWVyH8oEB-EavmmtBChFHdEc2xYUk0zlACLcB/s1600/DeadlockAvoidance01.png)

<br>

- 가용 자원이 기대 자원보다 크지 않으면 자원을 할당하지 않는다. 가용 자원을 사용하여 작업을 마칠 수 있는 프로세스가 없다는 의미이므로 **불안정 상태**이다.

![](https://3.bp.blogspot.com/-13e9sDAKer0/WP4CBfKvpjI/AAAAAAAABLo/69kjCBsSsU8b__-HvbrrYASZwneRq3PVwCLcB/s1600/DeadlockAvoidance02.png)

한계:

프로세스가 자신이 사용할 모든 자원을 미리 알고있어야 한다.

시스템의 전체 자원수가 고정적이어야 한다.

자원이 낭비된다.

### 교착 상태 검출

교착 상태 예방은 정확한 구현이 어렵고, 교착 상태 회피는 자원을 낭비하는 문제가 있다. 따라서 제일 현실적인 것은 교착 상태 검출 방법인데, 이는 운영체제가 프로세스의 작업을 관찰하면서 교착 상태 여부를 계속 주시하는 방식이다. 교착 상태가 발견되면 이를 해결하기 위해 교착 상태 회복 단계를 밟는다.

#### 타임 아웃을 이용한 교착 상태 검출(가벼운 교착 상태 검출)

일정 시간동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법

한계 :

엉뚱한 프로세스가 강제 종료될 수 있다.

- 교착 상태 외의 다른 이유로 작업이 진행되지 못하는 프로세스가 강제 종료될 수 있다.

모든 시스템에 적용할 수 없다.

- 네트워크로 연결되어 있는 분산 시스템의 경우에는 프로세스 자체의 문제 외에도 다양한 원인이 타임아웃을 발생시키므로 이 방법을 적용하기 어렵다.

#### 자원 할당 그래프를 이용한 교착 상태 검출(무거운 교착 상태 검출)

![](https://velog.velcdn.com/images%2Fsunil1369%2Fpost%2Fd157f5dc-6ddc-4abb-b969-8df035dbfa93%2Fimage.png)

점선 - 실선 - 점선 사이클이 원형을 이루면 교착상태가 발생할 것으로 볼 수 있다.

장점 : 프로세스의 작업을 제한하지 않으면서 교착 상태를 검출할 수 있다.
단점 : 자원 할당 그래프 관련 연산이 추가되므로 오버헤드가 발생한다.

### 교착 상태의 회복

교착 상태에서 프로세스들을 회복하기 위해 강제 종료를 하게 되는데 2 가지 방법이 있다.

#### 교착 상태를 일으킨 모든 프로세스를 종료

종료된 프로세스들이 동시에 다시 작업을 시작하면 다시 교착 상태를 일으킬 가능성이 크다. 따라서 이 방식으로 종료한 후 다시 실행할 때는 기준을 정해 순서대로 다시 실행해야 한다.

#### 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료

적용할 수 있는 기준 :

- 우선순위가 낮은 프로세스를 먼저 종료
- 우선순위가 같은 경우 작업 시간이 짧은 프로세스를 먼저 종료
- 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료

### 다중 자원과 교착 상태 검출

단일 자원만 있는 환경에서는 자원 할당 그래프에 사이클의 여부 존재여부 교착 상태를 검출할 수 있었지만, 다중 자원이 있는 환경에서는 이 방식으로 검출할 수 없다. 이에 다중 자원이 있는 환경에서는 대기 그래프와 그래프 감소를 통해 교착 상태를 검출한다.

![](https://kangraemin.github.io/assets/images/posts/2020-12-04-Deadlock/pic6.png)

---

질문거리

- 교착 상태가 뭔가요?

- 교착 상태가 발생하려면 어떤 조건들이 충족되어야 할까요?

- 교착상태, 경쟁 상태, 기아 상태의 차이점이 뭔가요?

- 교착상태를 해결하는 방법은 어떤것들이 있을까요?

- 교착 상태를 검출하는 방법들에 대해서 설명해주세요
- time out으로 데이터의 일관성이 깨질 수 있는데 이를 해결하는 방법에 대해서 설명해주세요(Transaction)

- 교착 상태에 빠진 프로세스들을 강제 종료할 때 어떤식으로 종료해야 할까요?

- 다중 자원이 존재하는 시스템에서는 어떤식으로 교착 상태를 검출할 수 있나요?
