# 교착 상태

## 교착 상태의 정의

2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며 작업을 더 이상 진행하지 못하는 상태를 <b>_교착 상태(dead lock)_</b> 이라고 한다.

![robot](https://user-images.githubusercontent.com/103870198/212526331-ee3e0f56-e8fb-4920-8b59-9a1e1a119384.jpg)

<br />

### 교착 상태와 아사 현상의 차이점

- 아사 현상 : 운영체제가 잘못된 정책을 사용하여 특정 프로세스의 작업이 지연되는 문제
- 교착 상태 : 여러 프로세스가 작업을 진행하다 보니 자연적으로 일어나는 문제

<br />

### 교착 상태의 발생

컴퓨터 시스템에서 교착 상태는 시스템 자원, 공유 변수(또는 파일), 응용 프로그램 등을 사용할 때 발생할 수 있다.

- 시스템 자원

  다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생한다.

  어떤 프로세스가 임계구역으로 보호되는 프린터, 스캐너, CD 레코더 등 동시에 같이 사용할 수 없는 시스템 자원을 할당받은 후

  양보하지 않는 경우를 예로 들을 수 있다.

- 공유 변수

  ![dealock1](https://user-images.githubusercontent.com/103870198/213149453-c18b85ac-76c9-4088-af8f-017fa7972b37.png)

  공유 변수를 사용할 때도 발생한다.

  한 변수를 할당받은 상태에서 다른 변수를 기다리면 교착 상태가 발생한다.

- 응용 프로그램

  데이터베이스에 저장된 데이터를 사용할 때는 데이터의 일관성을 유지해야 한다.

  DB는 데이터의 일관성을 유지하기 위해 잠금을 사용하는데, 이때 교착 상태가 발생할 수 있다.

<br />

<br />

### 자원 할당 그래프(resource allocation graph)

자원 할당 그래프는 프로세스가 어떤 자원을 사용 중이고 어떤 자원을 기다리고 있는지를 방향성이 있는 그래프로 표현한 것이다.

- 프로세스는 원으로 표현한다.

- 자원은 사각형으로 표현한다.

- 자원을 사용하고 있는 경우(할당된 경우) 자원으로부터 프로세스로 향하는 화살표로 표시한다.

- 반대로 프로세스가 자원을 기다리는 경우(대기하는 경우)는 프로레스로부터 자원으로 향하는 화살표로 표시한다.

- 여러 프로세스가 하나의 자원을 동시에 사용하면 <b>_다중 자원(multiple resoure)_</b> 라고 부른다.
  - 다중 자원은 수용할 수 있는 프로세스 수를 사각형 안에 작은 동그라미로 표현한다.

<br />

<br />

## 교착 상태 필요조건

교착 상태는 상호 배제(mutual exclusion), 비선점(non-preemption), 점유와 대기(hold and wait), 원형 대기(circular wait)를 모두 충족해야 발생한다.

- 상호 배제(mutual exclusion)

  한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 배타적인 자원이어야 한다.

  따라서 배타적인 자원 사용 시 교착 상태 발생

- 비선점(non-preemption)

  한 프로세스가 사용중인 자원은 중간에 다른 프로세스가 빼앗을 수 없는 비선점 자원이어야 한다.

- 점유와 대기(hold and wait)

  프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태여야 한다.

- 원형 대기(circular wait)

  점유와 대기를 하는 프로세스간의 관계가 원을 이루어야 한다.

  점유와 대기를 하는 프로세스들이 서로 방해하는 방향이 원을 이루면 프로세스들이 서로 양보하지 않기 때문에 교착 상태에 빠진다.

<br />

<br />

### 교착 상태 해결 방법

교착 상태를 해결하는 방법은 예방(prevention), 회피(avidance), 검출(detection)이며, 추가적으로 교착 상태가 발견된 후에 자원을 회복(recovery)하는 방법도 있다.

| 해결 방법      | 특징                                                |
| -------------- | --------------------------------------------------- |
| 교착 상태 예방 | 교착 상태를 유발하는 네 가지 조건을 무력화 한다.    |
| 교착 상태 회피 | 교착 상태가 발생하지 않는 수준으로 자원을 할당한다. |
| 교착 상태 검출 | 자원 할당 그래프를 사용하여 교착 상태를 발견한다.   |
| 교착 상태 회복 | 교착 상태를 검출한 후 해결한다.                     |

<br />

- 교착 상태 예방

  교착 상태를 유발하는 네 가지 조건이 발생하지 않도록 하는 방식 -> 실효성이 적어 잘 사용되지 않는다.

- 교착 상태 회피

  자원을 할당하다가 교착 상태를 유발할 가능성이 있다고 판단되면 자원 할당을 중단하고 지켜보는 것 -> 얼마만큼 할당해야 발생하지 않는다는 보장이 없으므로 실효성이 적다.

- 교착 상태 검출과 회복

  별다른 제약 없이 모니터링하다가 교착 상태가 발생하면 회복 단계를 진행하는 방식 -> 교착 상태를 해결하는 현실적인 방법

<br />

### 교착 상태 예방

- 상호 배제 예방

  시스템 내에 있는 독점적으로 사용할 수 있는 자원을 없애버리는 방법

- 비선점 예방

  모든 자원을 빼앗을 수 있도록 만드는 방법

- 점유와 대기 예방

  전부 할당하거나 아니면 아예 할당하지 않는 방식을 적용하는 것

  점유와 대기 예방의 단점

  - 프로세스가 필요한 모든 자원을 자세히 알기 어렵다.

  - 자원의 활용성이 떨어진다.

  - 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리함 -> 아사현상 발생

  - 결국 일괄 작업 방식으로 동작함.

- 원형 대기 예방

  자원을 한 방향으로만 사용하도록 설정함으로써 원형 대기를 예방할 수 있다.

  모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 방식

  원형 대기 예방의 단점

  - 프로세스 작업 진행에 유연성이 떨어진다.

  - 자원의 번호를 어떻게 부여할 것인지가 문제

<br />

### 교착 상태 회피

교착 상태 회피는 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어주면 교착 상태가 발생하는지 파악하여 그 수준 이하로 자원을 나누어주는 방법이다.

자원의 총수와 현재 할당된 자원의 수를 기준으로 시스템을 _안정 상태(safe state)_ 와 _불안정 상태(unsafe state)_ 로 나눈다.

<br />

### 은행원 알고리즘

다익스트라가 제안한 알고리즘, 대출 금액이 가능한 범위 내이면 대출을 해주고 아니면 거부되는 것과 유사해서 불리게 됨.

최악의 경우를 기준으로 함으로써 문제 상황을 철저히 피하여 교착 상태를 막는다.

- 프로세스는 자신이 사용할 자원의 최대 수를 운영체제게 알려준다.

- 각 프로세스에 할당된 자원의 수는 _할당 자원_ 에 표시된다.

- 자신이 선언한 최대 자원에서 현재 할당된 자원 수를 빼면 _기대 자원_ 이 된다.

- 전체 자원에서 각 프로세스에 할당되고 남은 자원의 수가 _가용 자원_ 이다.

| 변수                  | 설명                                                                                         |
| --------------------- | -------------------------------------------------------------------------------------------- |
| 전체 자원(Total)      | 시스템 내 전체 자원의 수                                                                     |
| 가용 자원(Available)  | 시스템 내 현재 사용할 수 있는 자원의 수( 가용 자원 = 전체 자원 - 모든 프로세스의 할당 자원 ) |
| 최대 자원(Max)        | 각 프로세스가 선언한 최대 자원의 수                                                          |
| 할당 자원(Allocation) | 각 프로세스에 현재 할당된 자원의 수                                                          |
| 기대 자원(Expect)     | 각 프로세스가 앞으로 사용할 자원의 수( 기대 자원 = 최대 자원 - 할당 자원 )                   |

- 각 프로세스의 기대 자원과 비교하여 가용 자원이 하나라도 크거나 같으면 자원을 할당한다.

- 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않는다.

<br />

### <b>안정 상태</b>

```
  각 프로세스의 기대 자원과 비교하여 가용 자원이 크거나 같은 경우가 한 번 이상인 경우
```

<br />

### 교착 상태 회피의 문제점

아래와 같은 교착 상태 회피의 문제점 떄문에 사용하지 않는다.

- 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 한다.

- 시스템의 전체 자원 수가 고정적이어야 한다.

- 자원이 낭비된다.

<br />

### 교착 상태 검출

교착 상태 예방은 실제로 구현하기 어렵고, 교착 상태 회피는 구현할 수는 있지만 자원을 낭비하는 문제가 있다.

교착 상태 해결 방법 중 가장 현실적인 것은 바로 교착 상태 검출이다.

### <b>운영체제가 프로세스의 작업을 모니터링 -> 교착 상태 발견 -> 교착 상태 회복</b>

<br />

### 타임아웃을 이용한 교착 상태 검출

- 일정 시간 동안 작업이 진행되지 않은 프로세스를 교착상태가 발생한 것으로 간주하여 처리하는 방법

- 타임아웃을 이용한 검출 방법을 _가벼운 교착 상태 검출_ 이라고 부른다.

- 문제점

  - 엉뚱한 프로세스가 강제 종료될 수 있다.
    - 교착상태 외의 다른 이유로 작업이 진행되지 못하는 프로세스가 강제 종료될 수 있다.
  - 모든 시스템에 적용할 수 없다.
    - 여러군데에 분산되어 있는 시스템의 경우 타임아웃 방법을 적용하여 교착 상태를 파악하기 어렵다.

타임아웃 방식은 대부분의 데이터베이스와 운영체제에서 선호되는 방식이다.

타임아웃으로 데이터의 일관성이 깨지는 문제를 해결하기 위해 _체크 포인트(check point)_ 와 _롤백(roll back)_ 을 사용한다.

- 체크 포인트(check point)

  작업을 하다가 문제가 생기면 저장된 상태로 돌아오기 위한 표시, 현재 시스템 상태가 하드 디스크에 저장된다.

  이렇게 저장된 데이터를 <b>_스냅샷(snap shot)_</b> 이라고 한다.

- 롤백(roll back)

  작업을 하다가 문제가 발생하여 과거의 체크포인트로 되돌아가는 것을 말한다.

  롤백이 일어나면 저장된 스냅샷을 복원하여 체크포인트 시점으로 되돌린다.

<br />

### 자원 할당 그래프를 이용한 교착 상태 검출

- 자원 할당 그래프를 이용한 검출 방법을 _무거운 교착 상태 검출_ 이라고 부른다.
- 프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있는게 장점
- 자원 할당 그래프를 유지하고, 갱신하고, 검사하는 추가 작업으로 인한 오버헤드 발생이 단점
- 오버헤드를 줄이기 위해 자원이 할당될 때마다 검사를 하는 것이 아닌 일정 시간마다 하는 방법도 있음

<br />

### 교착 상태 회복

교착 상태가 검출되면 이를 푸는 후속 작업을 하는데 이를 교착 상태 회복이라 한다.

교착 상태 회복 단계에서는 교착 상태를 유발한 프로세스를 강제로 종료한다.

- 교착 상태를 일으킨 모든 프로세스를 동시에 종료
  - 종료된 프로세스들이 동시에 작업을 시작하면 다시 교착 상태를 일으킬 가능성이 크다.
  - 다시 실행할 때는 순차적으로 실행해야 하며, 기준이 필요
- 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
  - 어떤 프로세스부터 종료할 것인지 기준이 필요
    - 우선순위가 낮은 프로세스를 먼저 종료한다.
    - 우선순위가 같은 경우 작업 시간이 짧은 프로세스를 먼저 종료한다.
    - 위의 두 조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료한다.

<br />

<br />

## [심화학습] 다중 자원과 교착 상태 검출

하나의 자원을 여러 개의 프로세스가 동시에 상요할 수 잇는 경우에는 교착 상태 검출이 복잡하다.

<br />

### 대기 그래프와 그래프 감소

- 대기 그래프(wait graph)

  자원 할당 그래프에서 프로세스와 프로세스 간에 기다리는 관계만 나타낸 그래프

- 그래프 감소(graph reduction)

  대기 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워가는 작업을 말한다.

<hr >

> q1. 데드락이 무엇인가요?

> q2. 식사하는 철학자 문제는?

> q3. 데드락의 발생 조건?

> q4. 데드락 해결 방법
