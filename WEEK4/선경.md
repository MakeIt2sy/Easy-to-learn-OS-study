-----

Chapter06. 교착 상태

-----

### 01. 교착 상태의 개요
#### 교착 상태란?
2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며  
작업을 더 이상 진행하지 못하는 상태  
자연적으로 발생하며 에이징으로 해결할 수 없고 정책을 바꾼다고 해서 막을 수도 없음

ex)

![교착상태 예시 이미지](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Ft1.daumcdn.net%2Fcfile%2Ftistory%2F997664425C5935A023)  

위의 그림과 같이 자동차(=프로세스) 들이 현재 위치한 길(=자원)을 점유함과 동시에  
다른 차가 사용하는 길을 사용하려고 대기하고 있지만  
다른 길을 사용할 수 없으며 현재 길에서도 벗어나지 못하는 상태  

#### 교착 상태의 발생  
* 시스템 자원
  다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생
* 공유 변수  
  임계구역 문제를 해결하기 위한 코드로, 무한 대기를 막지 못해 교착 상태가 발생한 경우  
* 응용 프로그램  
  같은 응용프로그램에서도 발생  
  데이터베이스는 데이터의 일관성을 유지하기 위해 잠금을 사용하는데, 이때 교착 상태가 발생할 수 있음

#### 아사 현상이란?  
정책상 잘못이나 오류로 인해 특정 프로세스의 작업이 이루어지지 않는 것  
아사 현상과 교착 상태는 다름  
아사 현상은 몇 번 이상 양보했다면 더 이상 양보하지 않도록 조정하는 **에이징**으로 해결할 수 있음

#### 자원 할당 그래프  
프로세스가 어떤 자원을 사용 중이고 어떤 자원을 기다리고 있는지를 방향성 있는 그래프로 표현한 것  
어떤 프로세스에 자원이 할당되어 있는지 혹은 어떤 프로세스가 자원을 기다리고 있는지 한눈에 파악 가능  

ex)

![자원 할당 그래프 예시 이미지](https://velog.velcdn.com/images%2Fjujube0%2Fpost%2F64eba89e-d868-4a57-805e-82b6667fb836%2F6369447C-EF1A-4E2C-858C-AE32807058DE.png)  

* 원 : 프로세스
* 사각형 : 자원
* 사각형 → 원 화살표 : 자원을 사용하고 있는 경우(할당된 경우)  
* 원 → 사각형 : 프로세스가 자원을 기다리는 경우(대기하는 경우)  

#### 다중 자원  
여러 프로세스가 하나의 자원을 동시에 사용  

ex)  

![다중 자원 그래프 예시 이미지](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbqMCCQ%2FbtqNMN6hhgc%2FSU6oCgTuQ2bfLOX9In36H1%2Fimg.png)  

* 사각형 안에 작은 동그라미 : 수용할 수 있는 프로세스 수 (자원이 동시에 사용할 수 있는 프로세스 수)

#### 식사하는 철학자 문제  
교착 상태를 설명하기 위한 예로 오래전부터 사용  

![식사하는 철학자 문제 자원 할당 그래프 예시](https://velog.velcdn.com/images/suker80/post/ce17c756-fc6d-45c2-a688-72dce4047d60/image.png)  

식사하는 철학자 문제에서 교착 상태가 발생하는 조건
1. 철학자들은 서로 포크를 공유할 수 없음  
   (교착 상태 필요 조건의 상호 배제에 해당)
2. 각 철학자는 다른 철학자의 포크를 빼앗을 수 없음  
   (교착 상태 필요 조건의 비선점에 해당)
3. 각 철학자는 왼쪽 포크를 잡은 채 오른쪽 포크를 기다림  
   (교착 상태 필요 조건의 점유와 대기에 해당)
4. 자원 할당 그래프가 원형  
   (교착 상태 필요 조건의 원형 대기에 해당)


### 02. 교착 상태 필요조건  
#### 교착 상태 필요조건
상호 배제, 비선점, 점유와 대기, 원형 대기 4가지의 조건이 있고,  
이 중 단 하나라도 충족하지 않으면 교착상태는 발생할 일이 없음  

* 상호 배제 :  
  베타적인 자원을 사용하면 교착 상태 발생  
* 비선점 :  
  자원을 빼앗을 수 없으면 공유할 수도 없으므로 교착 상태 발생  
* 점유와 대기 :  
  프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태여야 함  
* 원형 대기 :  
  점유와 대기를 하는 프로세스 간의 관계가 원을 이루어야 함 (서로 양보하지 않기 때문)  

### 03. 교착 상태 해결 방법  
#### 교착 상태 예방  
교착 상태를 유발하는 네 가지 조건 중 하나라도 막음  
그러나 실효성이 적어 잘 사용되지 않음  

* 상호 배제 예방 :  
  독점적으로 사용할 수 있는 자원을 없애버리는 방법  
  현실적으로 상호 배제를 무력화하는 것은 사실상 어려움
* 비선점 예방 :  
  모든 자원을 빼앗을 수 있도록 만드는 방법  
  사실상 시스템의 모든 자원을 빼앗을 수 있도록 하지 못함(예를 들면 임계구역을 보호하기 위한 잠금)
  아사 현상을 일으킬 가능성 있음
* 점유와 대기 예방 :  
  전부 할당하거나 아예 할당하지 않는 방식  
  앞의 두 방식은 자원에 대한 제약을 풀고자 하는 방식이지만  
  이 방식은 자원이 아닌 프로세스의 자원 사용 방식을 변화시켜 교착 상태를 처리함  
  단점 :  
  * 프로세스가 자신이 사용하는 모든 자원을 자세히 알기 어려움
  * 자원의 활용성 떨어짐
  * 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리
  * 결국 일괄 작업 방식으로 동작  
* 원형 대기 예방 :  
  자원을 한 방향으로만 사용하도록 설정  
  즉 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 것  
  모든 자원을 할당받아야 실행할 수 있는 점유와 대기 예방보다 완화된 방법  
  단점 :  
  * 프로세스 작업 진행에 유연성이 떨어짐  
  * 자원이 번호를 어떻게 부여할 것인지 문제

#### 교착 상태 회피  
자원 할당량을 조절하여 교착 상태가 발생하지 않는 수준으로 자원을 할당  
그러나 자원을 얼만큼 할당해야 교착 상태가 발생하지 않는다는 보장이 없기 때문에 실효성 적음  

* 은행원 알고리즘 :  
  교착 상태 회피를 구현하는 방법중 하나  
  최악의 경우를 기준으로 하여 문제 상황을 철저히 피함  
  [은행원 알고리즘](https://jhnyang.tistory.com/102)  

단점 :  
* 프로세스가 자신이 사용할 모든 자원을 미리 선언해야 함  
* 시스템의 전체 자원 수가 고정적이어야 함  
* 자원이 낭비됨

#### 교착 상태 검출  
자원 할당 그래프를 모니터링하여 교착 상태를 발견  
교착 상태가 발견되면 회복 단계를 진행함  
교착 상태를 검출하고 회복시키는 것이 가장 현실적인 접근 방법  

* 타임아웃을 사용하는 방법(가벼운 교착 상태 검출)  
  일정 시간 동안 작업이 진행되지 않은 프로세스를 교착 상태가 발생한 것으로 간주하여 처리하는 방법  
  특별한 알고리즘이 없어 쉽게 구현 가능  
  단점 :  
  * 엉뚱한 프로세스가 강제 종료될 수 있음  
  * 모든 시스템에 적용할 수 없음

* 자원 할당 그래프를 사용하는 방법(무거운 교착 상태 검출)  
  시스템 내의 프로세스가 어떤 자원을 사용하고 있는지 혹은 기다리고 있는지를 알 수 있음  
  장점 :  
  프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 파악할 수 있음  
  단점 :  
  자원 할당 그래프를 유지하고, 갱신하고, 사이클을 검사하는 추가 작업으로 인해 오버헤드가 발생함

#### 교착 상태 회복  
교착 상태를 검출한 후 해결  
교착 상태를 유발한 프로세스를 강제 종료

* 교착 상태를 일으킨 모든 프로세스를 동시에 종료  
* 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료


### 04. [심화학습] 다중 자원과 교착 상태 검출  
다중 자원의 경우 교착 상태 검출이 복잡  
대기 그래프와 그래프 감소 방법을 이용하여 사이클을 찾음  

* 대기 그래프  
  자원 할당 그래프에서 프로세스와 프로세스 간에 기다리는 관계만 나타낸 그래프  
* 그래프 감소  
  대기 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워가는 작업


#### 예상 질문
* 교착 상태와 아사 현상의 차이는?
* 교착 상태란 무엇인가요?
* 교착 상태의 필요 조건들을 설명하고 교착 상태를 관리하는 방법들도 설명해주세요.  
* 교착 상태 해결방법들을 각각 설명해주세요.  
* 교착 상태와 기아 상태의 해결방법은 무엇인가요.  
* 교착 상태가 발생하는 경우를 하나 설명해주세요.
* 회피 기법인 은행원 알고리즘이 뭔지 설명해주세요.
* 기아상태를 설명하는 식사하는 철학자 문제에 대해 설명해보세요. 그리고 그 해결책은 무엇인가요.


#### 참고  
[[OS]교착상태란 무엇인가?](https://coding-factory.tistory.com/311)