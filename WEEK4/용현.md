# Deadlock

##  Q&A:
- starvation, deadlock 차이 
- https://www.geeksforgeeks.org/difference-between-deadlock-and-starvation-in-os/

---
# Deadlock
- 2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며 작업을 더 이상 진행하지 못하는 상태
- 데드락은 다른 프로세스와 공유할 수 없는 자원을 사용할 때 발생한다. ex) 시스템 자원, 공유변수, 데이터베이스와 같은 응용프로그램

---
# Deadlock 필요조건

데드락은 아래 4가지 조건을 모두 충족해야 발생한다.

- 상호배제
  - 한 프로세스가 사용하는 자원은 다른 프로세스와 공유할 수 없는 배타적 자원이어야 한다
  - 배타적 자원은 임계구역으로 보호되기 때문에 동시에 사용할 수 없다.
- 비선점
  - 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 빼앗을 수 없는 비선점 자원이여야 한다.
- 점유와 대기
  - 프로세스가 어떤 자원을 점유하고 있는 상태에서 다른 자원을 기다리는 상태여야 한다.
- 원형대기
  - 점유와 대기를 하는 프로세스 간의 관계가 사이클을 형성해야 한다.

---
# 해결방법


## 교착 상태 예방
데드락 필요조건 중 하나라도 발생하지 않도록 막아 교착 상태를 처리하는 방법

### 1. 상호 배제 예방
- 시스템 내에 있는 상호 배타적인 모든 자원, 즉 독점적으로 사용할 수 있는 자원을 없애는 방법
- 하지만 시스템 내에서는 공유할 수 없는 자원이 있기 때문에 사용할 수 없다.


### 2. 비선점 예방
- 모든 자원을 빼앗을 수 있도록 만드는 방법
- 어떤 자원을 빼앗을 수 있도록 할지라도 어떤 기준으로, 빼앗은 시간 중 얼마나 사용할지 결정하기 어렵다.

### 3. 점유와 대기 예방
- 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
- **전부 할당 하거나 아니면 아예 할당하지 않는 방식을 적용하는 것**
- 단점
  - 프로세스가 자신이 사용하는 모든 자원을 알기 어렵다
  - 자원의 활용성이 떨어진다
  - 많은 자원을 사용하는 프로세스가 적은 자원을 사용하는 프로세스보다 불리하다

### 4. 원형 대기 예방
- **점유와 대기를 하는 프로세스들이 서클을 이루지 못하도록 막는 방법**
- 자원을 한 방향으로만 사용하도록 설정함으로써 원형대기를 예방할 수 있다.
  - ex: 모든 자원에 숫자를 부여하고 숫자가 큰 방향으로만 자원을 할당하는 것이다.


자원을 보호하기 위해 상호배제와 비선점을 예방하기 어렵고, 점유와 대기,원형 대기는 프로세스 작업 방식을 제한하고 자원을 낭비하기 때문에 사용할 수 없다.

---
## 교착 상태 회피
- 프로세스에 자원을 할당할 때 어느 수준 이상의 자원을 나누어 주면 교착 상태가 발생하는지 파악하여 그 수준이하로 자원을 나누어주는 방법
- 교착 상태가 발생하지 않는 범위내에서만 자원을 할당하고, 교착 상태가 발생하는 범위에 있으면 프로세스를 대기 시킨다.
  - **즉, 자원을 많이 할당할수록 교착 상태가 발생할 확률이 커짐을 이용하는 것이다.**

**Banker(은행원) 알고리즘**
- 각 프로세스의 기대 자원과 비교하여, 가용 자원이 하나라도 크거나 같으면 자원을 할당한다.
  - 가용 자원이 기대 자원보다 크다는 것은 그 자원을 사용하여 작업을 끝낼 수 있는 프로세스가 있다는 안정상태이다.
- 가용 자원이 어떤 기대 자원보다 크지 않으면 할당하지 않는다.
  - 가용 자원을 사용하여 작업을 마칠 수 있는 프로세스가 없다는 의미이므로 불안정 상태이다.

> 안정 상태
>
> 각 프로세스의 기대 자원과 비교하여 가용 자원이 크거나 같은 경우가 한 번이상인 경우

**단점**
- 교착 상태가 발생하지 않을 수준까지만 자원을 나눠줘야 하므로,
- 프로세스는 자신이 사용할 모든 자원을 미리 선언해야 한다.
- 시스템의 전체 자원수가 고정적이다.
- 자원이 낭비된다
  - 교착 상태 회피는 실제로 교착 상태가 발생하지 않는데도 발생할 것이라고 예상함으로써 프로세스 자원 할당에 제약을 두기 때문이다.
---
## 교착 상태 검출
- 운영체제가 프로세스의 작업을 관찰하면서 교착 상태 발생 여부를 계속 주시하는 방식
- 교착 상태가 발견되면 이를 해결하기 위해 교착 상태 회복 단계를 밟는다.

### 타임아웃을 이용한 방법
- 일정 시간 동안 작업이 진행되지 않는 프로세스를 교착 상태가 발생한것으로 간주하여 처리한다

**단점**
- 엉뚱한 프로세스가 강제 종료될 수 있다
- 모든 시스템에 적용할 수 없다
  - 분산 데이터베이스의 경우, 교착상태로 인한 지연인지 정확히 알 수 없기 때문이다.

위와 같은 문제에도 불구하고 타임아웃은 대부분의 DB나 운영체제에서 많이 선호한다. (자원 할당 그래프를 이용하는 방법은 작업양이 너무 많아진다.)

  
### 할당 그래프를 이용하는 방법
- 단일 자원을 사용하는 경우 자원할당그래프에 사이클이 있으면 교착상태이다

**단점**
- 자원 할당 그래프를 유지하고, 업데이트하고, 사이클을 검사하는 추가 작업으로 인해 오버헤드가 발생하는 단점이 있다.

---

## 교착 상태 회복
- 교착 상태가 검출되면 교축 상태를 푸는 후속작업을 한다
- 교착 상태를 일으킨 모든 프로세스를 동시에 종료하거나
  - 다시 실행할 때는 순차적으로 실행해야하므로, 어떤 프로세스를 먼저 실행할 것인지 기준이 필요함
- 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료한다.
  - 어떤 프로세스부터 종료할지 기준이 필요함
    - 우선순위가 낮은 프로세스를 먼저 종료한다
    - 우선순위가 같은 경우, 작업 시간이 짦은 프로세스를 먼저 종료한다
    - 위 두조건이 같은 경우 자원을 많이 사용하는 프로세스를 먼저 종료한다

