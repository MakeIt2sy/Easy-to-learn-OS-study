# 프로세스와 스레드

### 프로세스

프로그램이 실행을 위해 메모리에 올라온 상태

### 프로세스의 4가지 상태

생성 -> 준비 -> 실행 -> 완료

4가지 상태 외에 입출력 요청이 있을 때 효율적으로 처리하기 위해 대기 상태가 추가되었다.

<br>

#### 생성 상태(create)

프로세스가 메모리에 올라와 PCB를 할당받고 실행 준비를 완료한 상태

#### 준비 상태(ready)

실행 대기 중인 프로세스가 CPU를 얻을 때까지 기다리는 상태, PCB는 준비 큐 에서 기다리며 CPU 스케쥴러에 의해 관리된다. CPU 스케쥴러는 준비 상태에서 큐를 몇 개 운영할지, 큐에 있는 어떤 프로세스의 프로세스 제어 블록을 실행 상태로 보낼지를 결정한다.

CPU 스케쥴러가 PCB를 선택하는 작업은 dispatch(PID) 명령으로 처리한다.

#### 실행 상태(running)

준비 상태에 있는 프로세스 중 하나가 CPU를 할당받아 실제 작업을 수행하는 상태, 실행 상태인 프로세스는 할당된 time-slice 동안 작업하고 timeout(PID)명령이 실행되어 다시 준비상태로 변경된다. 만약 실행하던 중 작업이 완료된다면 exit(PIC) 명령이 실행되어 프로세스가 정상 종료된다.

#### 대기 상태(wait)

실행중이던 프로세스가 입출력 요청 완료를 위해 실행을 중지한 상태, 대기 상태의 프로세스는 입출력장치별로 마련된 큐에서 기다린다. 요청한 입출력이 완료되면 입출력 관리자는 인터럽트를 통해 wakeup(PID)명령으로 해당 프로세스의 PCB를 준비상태로 이동시킨다.

#### 완료상태

실행 상태의 프로세스가 주어진 시간 안에 작업을 마친 상태, 코드와 사용했던 데이터를 메모리에서 삭제하고 PCB를 폐기한다. 정상적인 종료의 경우에는 exit()으로 처리하고, 강제 종료되는 경우에는 디버깅을 위해 강제 종료 직전의 메모리 상태를 저장장치로 옮기는 코어 덤프(core dump)를 실행한다.

### 휴식상태와 보류상태

대부분의 프로세스는 위 5가지의 활성 상태로 운영되지만, 이 외에 휴식 상태와 보류 상태가 있다. 둘 다 실행이 중단된 상태라는 점에서 같지만, 휴식상태는 프로세스가 메모리에 있으나 멈춘것이고 보류상태는 프로세스가 메모리에서 쫓겨나 스왑영역에 있는 상태라는 점에서 다르다.

<br>

### PCB(프로세스 제어 블록)

#### 구성요소

- 포인터 : PCB의 첫번째 블록에 위치하며, 프로세스의 현재 상태를 저장
- 프로세스 상태 : PCB의 두번째 블록에 위치하며, 생성, 준비, 실행, 대기, 종료
- 프로세스 식별자(PID) : 프로세스를 식별하는 ID
- 프로그램 카운터 : 다음에 실행될 명령어의 위치를 가리키는 값
- 프로세스 우선순위 : 프로세스의 context switch가 일어날 때 운영되고 있는 큐의 우선순위를 고려하는데, 프로세스가 큐에 들어갈 때 우선순위별로 다른 큐에 저장된다.
- 각종 레지스터 정보
- 메모리 관련 정보 : 프로세스의 메모리 영역에 대한 정보 등
- 할당된 자원 정보
- 계정 정보
- 부모프로세스 구분자와 자식 프로세스 구분자 : 부모 프로세스를 가리키는 PPID와 자식 프로세스를 가리키는 CPID 정보 저장.

### 문맥교환(Context Switch)

실행중이던 프로세스가 자신의 time-slice를 다 사용하였거나 오류 등의 이유로 준비나 대기 상태로 내려가고 새로운 프로세스가 메모리에 올라와 CPU를 할당받는것

### 프로세스의 구조

- 코드 영역 : text 영역으로도 불리며, 실행될 프로그램의 코드가 저장되는 영역
- 데이터 영역 : 전역 변수나 static 변수들이 저장되는 영역
- 스택 영역 : 지역 변수나 파라미터, 리턴값, 함수 실행을 마치고 복귀할 주소 등이 저장되는 영역
- 힙 영역 : 동적 할당을 위한 메모리 영역(프로그래머가 사용하는 영역)

### 프로세스의 생성과 복사

#### fork()

실행중인 프로세스로부터 새로운 프로세스를 복사하는 함수

fork()를 실행하면 실행중이었던 프로세스는 부모 프로세스, 새로 생긴 프로세스는 자식 프로세스로 부모-자식 관계가 된다. 이 때, 부모 프로세스의 CPID는 fork()로 생성된 자식 프로세스의 PID로 바뀌고 자식 프로세스의 PPID는 기존 부모 프로세스의 PID로 바뀐다. 자식 프로세스의 CPID는 현재 존재하지 않으므로 -1을 할당받는다.

- 장점

  1.프로세스의 생성 속도가 빠르다.

  2.추가 작업 없이 자원을 상속할수 있다.

  3.시스템 관리를 효율적으로 할수있다.

#### exec()

기존의 프로세스를 새로운 프로세스로 전환하는 함수

새로운 프로세스를 만들려면 PCB를 만들고 메모리를 확보하는 등의 과정이 필요한데 exec()을 활용해 이를 생략할 수 있다. exec()을 실행하면 프로세스 식별자(PID, PPID, CPID)들만 남겨두고 기존 프로세스의 구조만 그대로 둔 채 내용은 새롭게 바꿔서 실행한다.

- 장점

  1.이미 만들어진 프로세스의 구조를 재활용

  2.재활용을 하면 프로세스 제어 블록, 메모리 영역, 부모 자식 관계를 그대로 사용 가능하여 편리하다.

  3.새로운 코드 영역만 가져오면 되기 때문에 운영 체제의 작업이 수월하다.

### 프로세스의 계층 구조

fork()와 exec()을 이용해 프로세스간의 계층 구조를 형성할 수 있다. 이러한 계층구조는 여러 작업을 동시에 처리하거나, 자원 회수를 용이하게 하는데에 장점이 있다.

#### 고아 프로세스

부모 프로세스는 자원을 회수하기 위하여 자식 프로세스가 끝날 때 까지 기다려야 하는데, 예기치 않게 부모 프로세스가 먼저 종료되는 경우 자식 프로세스가 관리에서 벗어나게 되는데 이 자식 프로세스를 고아 프로세스라고 한다. 자식 프로세스가 종료했음에도 부모 프로세스가 자원을 회수하지 않는 경우도 있는데 이것을 좀비 프로세스 라고 한다.

### 스레드

프로세스의 코드에 정의된 절차에 따라 CPU에 작업 요청을 하는 실행 단위

### 관련 용어

#### 멀티프로그래밍

CPU가 하나의 프로세스를 처리할 때 프로세스가 입출력을 위해 대기 상태로 내려가는 경우가 있는데, 이 때 idle 상태가 되는 CPU를 효율적으로 활용하기 위해 다른 프로세스를 수행하게 만드는것을 뜻한다.

#### 멀티태스킹

다수의 작업을 시분할 방식으로 운영체제 스케줄링에 의해 번갈아 가면서 처리하는것을 뜻한다. 사용자는 다수의 작업이 동시에 처리되는 것처럼 느끼게 된다.

#### 멀티프로세싱(슈퍼스칼라)

CPU를 여러 개 사용하여 여러 개의 스레드를 동시에 처리하는 것을 뜻한다. 네트워크로 연결된 여러 컴퓨터에 스레드를 나누어 협업하는 분산 시스템도 멀티프로세싱이라고 부른다.

#### 멀티스레드

멀티스레드는 프로세스 내 작업을 여러 개의 스레드로 분할함으로써 작업의 부담을 줄이는 프로세스 운영 기법을 뜻한다.

### 멀티스레드의 장단점

#### 장점

- 자원의 중복사용을 피함으로써 메모리를 적게 사용한다.
- 하나의 프로세스에서 여러 스레드를 사용하면 작업의 효율을 높일 수 있다.

#### 단점

- 모든 스레드가 자원을 공유하기 때문에 하나의 스레드에 발생한 문제가 전체에 영향을 미친다.

### 멀티스레드 모델

- 커널스레드 : 커널이 직접 생성하고 관리하는 스레드
- 사용자 스레드 : 사용자의 라이브러리에 의해 구현된 일반적인 스레드

#### ManyToOne Model

N개의 사용자 스레드를 1개의 커널 스레드에 mapping 한다.

- 커널 스레드가 입출력을 위해 대기상태로 들어가게 되면 모든 사용자 스레드도 같이 대기하게 된다.
- 한 프로세스의 time-slice를 여러 스레드가 공유하기 때문에 여러 개의 CPU를 동시에 사용할 수 없다.

#### OneToOne Model

1개의 사용자 스레드를 1개의 커널 스레드에 mapping 한다.

- 커널 스레드는 독립적 스케쥴링이 가능하므로, 특정 스레드가 대기 상태에 들어가도 다른 스레드는 작업을 계속할 수 있다.
- 멀티 CPU를 사용할 수 있다.
- 문맥 교환을 할 때 오버헤드 때문에 느리게 작동한다.

#### ManyToMany Model

N개의 사용자 스레드를 N보다 작거나 작은 수의 커널 스레드에 mapping 한다.

- ManyToOne Model과 OneToOne Model의 장점을 다 가지고 있음
- 구현이 어려움

---

질문거리

프로세스와 스레드의 차이점이 뭔가요?

PCB에 대해 설명해주세요

문맥교환에 대해서 설명해주세요

프로세스의 구조에 대해서 설명해주세요

fork()와 exec에 대해서 설명해주세요

멀티프로세스에 대해서 설명해주세요

멀티스레드에 대해서 설명해주세요

멀티스레드의 장단점은 뭐가 있을까요?
