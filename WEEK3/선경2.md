-----

Chapter05. 컴퓨터의 구조와 성능 향상

-----

### 01. 컴퓨터의 기본 구성  

#### 프로세스 간 통신  
동시에 실행되는 프로세스끼리 데이터를 주고받는 작업  


#### 프로세스 간 통신의 종류  
* 프로세스 내부 데이터 통신 :  
  하나의 프로세스 내에 2개 이상의 스레드가 존재하는 경우의 통신  
  프로세스 내부의 스레드는 전역 변수나 파일을 이용하여 데이터를 주고받음  
  * 전역 변수를 이용한 통신 :  
    공동으로 관리하는 메모리를 사용하여 데이터를 주고받는 것  
    데이터를 보내는 쪽에서는 전역 변수나 파일에 값을 쓰고,  
    데이터를 받는 쪽에서는 전역 변수의 값을 읽음  
    주로 직접적으로 관련이 있는 프로세스간에 사용  
  * 파일을 이용한 통신 :  
    프로세스가 입출력 관리 프로세스에 쓰기를 요구하면 데이터가 저장되고,  
    읽기를 요구하면 입출력 관리 프로세스로부터 데이터를 가져옴  
    저장장치의 데이터를 읽고 쓰는 것도 일반 프로세스와 입출력 프로세스 간의 통신  
    파일을 이용한 통신은 부모-자식 관계 프로세스 간 통신에 많이 사용  
<br>
* 프로세스 간 데이터 통신 :  
  같은 컴퓨터에 있는 여러 프로세스끼리 통신하는 경우  
  공용 파일 또는 운영체제가 제공하는 파이프를 사용하여 통신  
  * 파이프를 이용한 통신 :  
    open() 함수로 기술자를 얻고 작업을 한 후 close() 함수로 마무리함  
    파이프로 양방향 통신을 하기 위해서는 파이프를 2개 사용해야 함  
    이름 없는 파이프 :  
    일반적으로 파이프라고 하면 이름 없는 파이프를 가리킴  
    부모와 자식 프로세스 혹은 같은 부모를 가진 자식 프로세스와 같이  
    서로 관련 있는 프로세스 간 통신에 사용됨  
    이름 있는 파이프 :  
    FIFO라 불리는 특수 파일을 이용하며  
    서로 관련 없는 프로세스 간 통신에 사용됨  
<br>
* 네트워크를 이용한 데이터 통신 :  
  여러 컴퓨터가 네트워크로 연결되어 있을 때 통신하는 경우  
  프로세스는 소켓을 이용하여 데이터를 주고받음  
  소켓을 이용하는 프로세스 간 통신을 네트워킹이라고 함  
  원격 프로시저 호출도 여기에 해당됨  
  * 소켓을 이용한 통신 :  
    네트워킹 상황에서의 통신  
    통신하고자 하는 프로세스는 소켓에 쓰기 연산을 하면 데이터가 전송되고,  
    읽기 연산을 하면 데이터를 받게됨  
    하나만 사용해도 양방향 통신이 가능


#### 프로세스 간 통신의 분류  
* 통신 방향에 따른 분류
  * 양방향 통신 :  
    데이터를 동시에 양쪽 방향으로 전송할 수 있는 구조  
    일반적인 통신은 모두 양방향 통신  
    ex) 소켓 통신  
  * 반양방향 통신 :  
    데이터를 양쪽 방향으로 전송할 수 있으나 동시 전송이 불가능한 구조  
    특정 시점에 한쪽 방향으로만 전송할 수 있음  
    ex) 무전기  
  * 단방향 통신 :  
    한쪽 방향으로만 데이터를 전송할 수 있는 구조  
    ex) 전역 변수, 파이프  
<br>  
* 통신 구현 방식에 따른 분류  
  상태 변화를 살펴보기 위해 반복문을 무한 실행하며 기다리는 것을 **바쁜 대기** 라고 하는데  
  바쁜 대기 문제를 해결하기 위해서는 데이터가 도착했음을 알려주는 **동기화**를 사용함  
  동기화 기능의 유무에 따라 구분됨
  * 동기화 통신 :  
    대기가 있는 통신  
    동기화를 지원함  
    데이터를 받는 쪽은 데이터가 도착할 때까지 자동으로 대기 상태에 머물러 있음  
    ex) 파이프를 이용한 통신, 소켓을 이용한 통신
  * 비동기화 통신 :  
    대기가 없는 통신  
    동기화를 지원하지 않음  
    데이터를 받는 쪽은 바쁜 대기를 사용하여 데이터가 도착했는지 여부를 직접 확인  
    통신 오버헤드는 적지만 바쁜 대기처럼 사용자가 직접 처리해야 하는 작업이 많음  
    ex) 전역 변수를 이용한 통신, 파일을 이용한 통신  


#### 프로세스 간 통신 요약  
|종류|운영체제 동기화 지원|open()/close() 사용|
|------|---|---|
|전역 변수|x (바쁜 대기)|x|
|파일|x (wait() 함수 사용)|o|
|파이프|o|o|
|소켓|o|o|  

<br>

### 02. 공유 자원과 임계구역  
#### 공유 자원의 접근  
여러 프로세스가 공동으로 이용하는 변수, 메모리, 파일 등을 **공유 자원** 이라고 함  
누가 언제 데이터를 읽거나 쓰느냐에 따라 그 결과가 달라질 수 있음  
따라서 프로세스들의 공유 자원 접근 순서를 정하여 예상치 못한 문제가 발생하지 않도록 해야함  
2개 이상의 프로세스가 공유 자원을 병행적으로 읽거나 쓰는 상황을 **경쟁 조건이 발생했다**고 함  


#### 임계구역  
공유 자원 접근 순서에 따라 실행 결과가 달라지는 프로그램의 영역   
ex) 프린터 1개를 여러 명이 동시에 사용하는 경우에서 프린터, 각 프로세스가 전역 변수를 사용하는 부분


#### 생산자-소비자 문제  
임계구역과 관련된 전통적인 문제  
생산자 프로세스와 소비자 프로세스가 서로 독립적으로 작업함  
생산자는 계속 물건을 생산해서 버퍼에 넣고 소비자는 계속 버퍼에서 물건을 가져옴  
버퍼는 작업을 계속하기 위해 원형 버퍼를 사용함  

#### 임계구역 해결 조건  
* 상호 배제 :  
  한 프로세스가 임계구역에 들어가면 다른 프로세스는 임계구역에 들어갈 수 없음  
  임계구역 내에는 한 번에 하나의 프로세스만 있어야 함  
* 한정 대기 :  
  한 프로세스가 자신의 임계구역에 진입하고자 요청을 한 후부터 이 요청이 허용될 때까지  
  다른 프로세스가 그들의 임계 구역에 진입할 수 있는 횟수가 제한되어야 함  
* 진행의 융통성 :  
  임계구역을 실행하고 있는 프로세스가 없을 때  
  몇개의 프로세스가 임계구역에 진입하고자 하면  
  이들의 진입 순서는 이들에 의해서만 결정되어야 함  
  또한 이 선택은 무한정 연기되어서는 안됨

[운영체제 - Process synchronization](https://dev-ahn.tistory.com/18)


### 03. 임계구역 해결 방법  
단순한 방법은 잠금을 이용하는 것  

#### 임계구역 해결 조건을 고려한 코드 설계  
* 상호 배제 문제 :  
  임계구역에 진입하기 전에 먼저 다른 프로세스가 사용 중인지 확인하며,  
  사용 중이면 끝날 때까지 무한 루프를 돌며 기다리고  
  그렇지 않으면 잠금을 걸고 임계구역에 진입하는 코드  
* 상호 배제 조건을 충족하지 않는 경우 :  
  하나의 프로세스가 주어진 CPU 시간을 모두 사용하고 타임아웃 상태일 때
  타임아웃 된 프로세스가 잠김 상태로 변경되기 전에  
  다른 프로세스가 잠김 상태로 변경되면  
  둘 다 임계구역에 진입하게 되어 상호 배제 조건을 보장하지 못함  
  또한 잠금이 풀리기를 기다리면서 바쁜 대기를 하기 때문에  
  작업을 할 필요가 없는 시간에도 계속 무한 루프를 돌면서 시스템 자원을 낭비하게 됨  
<br>
* 한정 대기 문제 :  
  잠금을 두개 사용하여 일단 잠금을 하고 다른 프로세스가 잠겼는지 확인함  
  두 프로세스의 상호 배제가 보장됨  
* 한정 대기 조건을 충족하지 않는 경우 :  
  두개의 프로세스가 모두 잠김 상태에서 CPU 시간을 다 써버리면  
  두 프로세스 모두 무한 루프에 빠져 임계구역에 진입하지 못함  
  이러한 상황을 **교착 상태**라고 함  
<br>
* 진행의 융통성 문제 :  
  공유 변수 lock을 사용하여 값으로 다른 프로세스가 임계구역에 있는지 없는지 확인함  
  잠금을 확인하는 문장이 하나이기 때문에 상호 배제와 한정 대기가 보장됨  
* 진행의 융통성 조건을 충족하지 않는 경우 :  
  그러나 하나의 프로세스가 임계구역에 진입했다가 나온 다음에야  
  다른 프로세스가 진입 할 수 있기 때문에 다른 프로세스가 또다른 프로세스의 진행을 방해할 수 있음  
  프로세스의 진행이 다른 프로세스로 인해 방해받는 현상을 **경직된 동기화** 라고 함  
<br>
* 하드웨어적인 해결 방법 :  
  **검사와 지정** 이라는 코드로 하드웨어의 지원을 받아 실행  
  검사와 지정 코드를 이용하면 명령어 실행 중간에 타임아웃이 걸려  
  임계구역을 보호하지 못하는 문제가 발생하지 않음  
  이 방법은 편리하지만 바쁜 대기를 사용하여 검사하기 때문에 자원 낭비가 있음  


#### 피터슨 알고리즘  
임계구역 문제를 해결하기 위한 알고리즘  
turn이라는 공유 변수를 추가로 사용하여 두 프로세스가 동시에 잠금 설정되어  
임계구역에 들어가지 못하는 상황을 대비하기 위한 장치  
즉 두 프로세스가 동시에 잠겨도 turn을 사용하여 다른 프로세스에 양보  
임계구역 해결의 세 가지 조건을 모두 만족하지만 2개의 프로세스만 사용 가능하다는 한계가 있음  


#### 데커 알고리즘  
임계구역 세 가지 조건을 모두 만족함  
하드웨어의 도움 없이도 임계구역 문제를 해결할 수 있다는 것이 특징
그러나 프로세스가 늘어나면 변수도 늘어나고 전체적인 알고리즘도 복잡해짐  


#### 세마포어  
앞에 내용들의 단점을 보완하기 위한 알고리즘  
간단하고 사용하기도 쉬움  
초기화가 끝난 후 임계구역에 들어가기 전에 사용 중이라고 [P()]를 사용하여 표시하고,  
임계구역에서 나올 때 비었다고 표시하는 [V()]를 사용하여 임계구역을 보호  
공유 자원이 여러 개일 때도 사용할 수 있음  
가장 큰 문제는 잘못된 사용으로 인해 임계구역이 보호받지 못한다는 것
* 프로세스가 세마포어를 사용하지 않고 바로 임계구역에 들어간 경우  
* P()를 두 번 사용하여 wake_up 신호가 발생하지 않은 경우  
* P()와 V()를 반대로 사용하여 상호 배제가 보장되지 않은 경우  


#### 모니터  
시스템 호출과 같은 개념  
보호할 자원을 임계구역으로 숨기고 임계구역에서 작업할 수 있는 인터페이스만 제공하여 자원을 보호  


### 예상질문  
Q. 교착상태에 대해서 간단히 설명해주세요.  
A. 둘 이상의 스레드가 다른 스레드가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황  
<br>
Q. 경쟁상태란 무엇인가요?  
A. 여러 프로세스 및 스레드가 공유 자원에 동시 접근 시 그 순서에 따라 결과가 달라지는 문제  
<br>
Q. 상호 배제, 임계구역, 경쟁에 대해 설명해보세요.  
A. 여러 스레드가 임계구역에 대해서 경쟁을 할 때 상호배제가 이루어져야만 스레드 동기화가 보장됨  
<br>
Q. 세마포어는 어떤건가요?  
A. 세마포어는 여러개의 프로세스가 접근 가능한 공유자원을 관리하는 방식 중 하나로  
   모든 교착 상태를 해결하지는 못함  
<br>
Q. 임계 구역 문제를 해결하기 위한 3가지 조건은 무엇이고 각각을 설명해주세요  
A. 상호 배제, 한정 대기, 진행의 융통성이 있음  
   상호 배제는 한 프로세스만 임계 구역을 사용해야 한다는 조건이고,  
   한정 대기는 특정 프로세스가 무한히 대기해서는 안된다는 조건이고,  
   진행의 융통성은 임계 구역이 비어있는 경우, 임계 구역을 대기하던 프로세스들만  
   해당 임계 구역으로 진입할 수 있는 결정에 참여 가능하다는 조건
  